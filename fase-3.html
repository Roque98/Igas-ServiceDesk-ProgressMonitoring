<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fase 3: Escalamiento - Módulo de Casos - iGAS Service Desk</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            color: #333;
            background: white;
            padding-top: 60px;
        }

        /* Navegación sticky */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #3E3E3E;
            padding: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .navbar ul {
            list-style: none;
            display: flex;
            flex-wrap: wrap;
            margin: 0;
            padding: 0;
        }

        .navbar li {
            margin: 0;
        }

        .navbar a {
            display: block;
            padding: 15px 20px;
            color: white;
            text-decoration: none;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            font-size: 14px;
        }

        .navbar a:hover {
            background: rgba(249, 176, 0, 0.1);
            color: #F9B000;
        }

        .navbar a.active {
            color: #F9B000;
            border-bottom-color: #F9B000;
            background: rgba(249, 176, 0, 0.05);
        }

        .header {
            background: linear-gradient(135deg, #F9B000 0%, #FDB913 100%);
            color: white;
            padding: 40px 30px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header .badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            margin: 10px 10px 0 0;
        }

        .badge-proceso { background: #FFC107; color: #333; }
        .badge-pendiente { background: rgba(255,255,255,0.3); }
        .badge-completado { background: #4CAF50; }
        .badge-critica { background: #F44336; }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .progress-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-bar-container {
            background: #e0e0e0;
            height: 30px;
            border-radius: 15px;
            position: relative;
            margin: 15px 0;
        }

        .progress-bar-fill {
            background: linear-gradient(90deg, #4CAF50 0%, #00A651 100%);
            height: 100%;
            border-radius: 15px;
            transition: width 0.3s ease;
        }

        .progress-bar-text {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            font-weight: bold;
            font-size: 14px;
        }

        .content-section {
            background: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .content-section h2 {
            color: #F9B000;
            font-size: 24px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #F9B000;
        }

        .content-section h3 {
            color: #3E3E3E;
            font-size: 20px;
            margin: 25px 0 15px 0;
        }

        .content-section h4 {
            color: #666;
            font-size: 16px;
            margin: 20px 0 10px 0;
        }

        .content-section ul, .content-section ol {
            margin: 15px 0 15px 30px;
        }

        .content-section li {
            margin: 8px 0;
        }

        .content-section code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .code-block {
            background: #f8f9fa;
            color: #333;
            padding: 20px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            border: 1px solid #e0e0e0;
            white-space: pre-wrap;
        }

        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 13px;
        }

        .info-box {
            background: #fff3cd;
            border-left: 4px solid #FFC107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .success-box {
            background: #d4edda;
            border-left: 4px solid #4CAF50;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .warning-box {
            background: #f8d7da;
            border-left: 4px solid #F44336;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        table th {
            background: #F9B000;
            color: white;
            padding: 12px;
            text-align: left;
        }

        table td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }

        table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .footer {
            background: #3E3E3E;
            color: white;
            padding: 30px;
            text-align: center;
            margin-top: 50px;
        }

        .footer p {
            margin: 5px 0;
        }

        @media (max-width: 768px) {
            .navbar ul {
                flex-wrap: wrap;
            }

            .navbar a {
                padding: 12px 15px;
                font-size: 13px;
            }

            .header h1 {
                font-size: 24px;
            }

            .container {
                padding: 20px 15px;
            }
        }

        @media print {
            body {
                padding-top: 0;
            }
            .navbar {
                display: none;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <ul>
            <li><a href="index.html">Inicio</a></li>
            <li><a href="overview.html">Overview</a></li>
            <li><a href="fase-0.html">Fase 0</a></li>
            <li><a href="fase-1.html">Fase 1</a></li>
            <li><a href="fase-2.html">Fase 2</a></li>
            <li><a href="fase-3.html" class="active">Fase 3</a></li>
            <li><a href="fase-4.html">Fase 4</a></li>
            <li><a href="fase-5.html">Fase 5</a></li>
            <li><a href="fase-6.html">Fase 6</a></li>
            <li><a href="fase-7.html">Fase 7</a></li>
        </ul>
    </nav>

    <div class="header">
        <div class="container">
            <h1>Fase 3: Escalamiento - Módulo de Casos</h1>
            <span class="badge badge-pendiente">Pendiente</span>
            <span class="badge badge-proceso">0%</span>
        </div>
    </div>

    <div class="container">
        <div class="progress-card">
            <h3>Progreso de la Fase</h3>
            <div class="progress-bar-container">
                <div class="progress-bar-fill" style="width: 0%;"></div>
                <div class="progress-bar-text">0% Completado</div>
            </div>
        </div>

        <div class="content-section"><h2>Objetivo</h2>
Implementar el módulo de Casos para escalamiento de tickets a otras áreas (Dev, Implementación, Facturación, Proveedor, Cobranza) con control de tiempo y notificaciones por email.

---

<div class="content-section"><h2>Tareas</h2>

<h3>1. Modelo de Datos - Casos en Supabase</h3>

<h4>1.1 Tabla Principal de Casos</h4>
</p><div class="code-block">CREATE TABLE public.casos (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  folio TEXT UNIQUE NOT NULL,
  ticket_id UUID REFERENCES tickets(id) NOT NULL,
  cliente_id UUID REFERENCES clientes(id) NOT NULL, -- Denormalizado para facilitar queries
  problema_descripcion TEXT,
  area_destino TEXT CHECK (area_destino IN ('Dev', 'Implementación', 'Facturación', 'Proveedor', 'Cobranza')) NOT NULL,
  motivo TEXT CHECK (motivo IN ('Bug', 'Mejora', 'Configuración', 'Proveedor', 'Administrativo')) NOT NULL,
  responsable_id UUID REFERENCES profiles(id),
  prioridad TEXT CHECK (prioridad IN ('Crítica', 'Alta', 'Media', 'Baja')),
  estatus_id UUID REFERENCES estatus_casos(id) NOT NULL,
  sla_objetivo_minutos INTEGER NOT NULL,
  fecha_creacion TIMESTAMPTZ DEFAULT NOW(),
  fecha_primera_respuesta TIMESTAMPTZ,
  fecha_resolucion TIMESTAMPTZ,
  fecha_compromiso DATE,
  tiempo_pausado_minutos INTEGER DEFAULT 0,
  resultado TEXT CHECK (resultado IN ('Listo para validar', 'Regresa a soporte', 'Cerrado')),
  numero_caso_externo TEXT, -- Número de caso del área de desarrollo
  email_enviado BOOLEAN DEFAULT false,
  creado_por UUID REFERENCES profiles(id) NOT NULL,
  cerrado_por UUID REFERENCES profiles(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Índices
CREATE INDEX idx_casos_folio ON casos(folio);
CREATE INDEX idx_casos_ticket ON casos(ticket_id);
CREATE INDEX idx_casos_cliente ON casos(cliente_id);
CREATE INDEX idx_casos_area ON casos(area_destino);
CREATE INDEX idx_casos_responsable ON casos(responsable_id);
CREATE INDEX idx_casos_estatus ON casos(estatus_id);
CREATE INDEX idx_casos_fecha_creacion ON casos(fecha_creacion DESC);</div>


<h4>1.2 Tablas Relacionadas</h4>
</p><div class="code-block">-- Bitácora de casos
CREATE TABLE public.caso_bitacora (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  caso_id UUID REFERENCES casos(id) ON DELETE CASCADE,
  usuario_id UUID REFERENCES profiles(id),
  tipo TEXT CHECK (tipo IN ('nota', 'cambio_estatus', 'asignacion', 'adjunto', 'email_enviado', 'numero_caso_recibido')) NOT NULL,
  mensaje TEXT,
  datos_adicionales JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Adjuntos de casos
CREATE TABLE public.caso_adjuntos (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  caso_id UUID REFERENCES casos(id) ON DELETE CASCADE,
  nombre_archivo TEXT NOT NULL,
  ruta_storage TEXT NOT NULL,
  tipo_archivo TEXT,
  tamanio_bytes BIGINT,
  subido_por UUID REFERENCES profiles(id),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Participantes
CREATE TABLE public.caso_participantes (
  caso_id UUID REFERENCES casos(id) ON DELETE CASCADE,
  usuario_id UUID REFERENCES profiles(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  PRIMARY KEY (caso_id, usuario_id)
);

-- Historial de asignaciones
CREATE TABLE public.caso_historial_asignaciones (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  caso_id UUID REFERENCES casos(id) ON DELETE CASCADE,
  de_usuario_id UUID REFERENCES profiles(id),
  a_usuario_id UUID REFERENCES profiles(id),
  motivo TEXT,
  asignado_por UUID REFERENCES profiles(id),
  created_at TIMESTAMPTZ DEFAULT NOW()
);</div>


<h4>1.3 Catálogos</h4>
</p><div class="code-block">-- Estatus de casos
CREATE TABLE public.estatus_casos (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  nombre TEXT UNIQUE NOT NULL,
  orden INTEGER,
  pausa_sla BOOLEAN DEFAULT false,
  es_final BOOLEAN DEFAULT false,
  color TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

INSERT INTO estatus_casos (nombre, orden, pausa_sla, es_final, color) VALUES
  ('Nuevo', 1, false, false, '#1de9b6'),
  ('En proceso', 2, false, false, '#04a9f5'),
  ('En espera', 3, true, false, '#f4c22b'),
  ('Listo para validar', 4, false, false, '#00A651'),
  ('Regresado a soporte', 5, false, true, '#a389d4'),
  ('Cerrado', 6, false, true, '#748892');

-- Áreas destino
CREATE TABLE public.areas_destino (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  nombre TEXT UNIQUE NOT NULL,
  email_notificacion TEXT,
  responsable_default_id UUID REFERENCES profiles(id),
  sla_default_horas INTEGER,
  descripcion TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

INSERT INTO areas_destino (nombre, email_notificacion, sla_default_horas) VALUES
  ('Dev', 'desarrollo@igas.mx', 48),
  ('Implementación', 'implementacion@igas.mx', 72),
  ('Facturación', 'facturacion@igas.mx', 24),
  ('Proveedor', 'proveedores@igas.mx', 96),
  ('Cobranza', 'cobranza@igas.mx', 48);</div>


<h3>2. Sistema de Folios para Casos</h3>
</p><div class="code-block">-- Secuencia por año
CREATE SEQUENCE caso_folio_seq;

-- Función para generar folio CASO-AAAA-####
CREATE OR REPLACE FUNCTION generar_folio_caso()
RETURNS TEXT AS $
DECLARE
  anio TEXT;
  numero INTEGER;
  folio TEXT;
BEGIN
  anio := EXTRACT(YEAR FROM NOW())::TEXT;
  numero := nextval('caso_folio_seq');

  -- Reset secuencia si cambió el año
  IF numero > 1 AND NOT EXISTS (
    SELECT 1 FROM casos
    WHERE folio LIKE 'CASO-' || anio || '-%'
  ) THEN
    ALTER SEQUENCE caso_folio_seq RESTART WITH 1;
    numero := nextval('caso_folio_seq');
  END IF;

  folio := 'CASO-' || anio || '-' || LPAD(numero::TEXT, 4, '0');
  RETURN folio;
END;
$ LANGUAGE plpgsql;

-- Trigger para asignar folio automáticamente
CREATE OR REPLACE FUNCTION asignar_folio_caso()
RETURNS TRIGGER AS $
BEGIN
  IF NEW.folio IS NULL THEN
    NEW.folio := generar_folio_caso();
  END IF;
  RETURN NEW;
END;
$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_asignar_folio_caso
  BEFORE INSERT ON casos
  FOR EACH ROW EXECUTE FUNCTION asignar_folio_caso();</div>


<h3>3. Sistema de Email para Escalamiento</h3>

<h4>3.1 Función para Enviar Email (Supabase Edge Function)</h4>
</p><div class="code-block">// supabase/functions/enviar-email-escalamiento/index.ts
import { serve } from "https://deno.land/std@0.168.0/http/server.ts"

serve(async (req) => {
  const { caso_id } = await req.json()

  // Obtener datos del caso
  const { data: caso } = await supabaseAdmin
    .from('casos')
    .select(`
      *,
      ticket:tickets(folio, descripcion),
      cliente:clientes(nombre_comercial),
      area:areas_destino(email_notificacion)
    `)
    .eq('id', caso_id)
    .single()

  // Enviar email usando Resend o SendGrid
  const emailHTML = `
    <h2>Nuevo Caso Escalado - ${caso.folio}</h2>
    <p><strong>Ticket Origen:</strong> ${caso.ticket.folio}</p>
    <p><strong>Cliente:</strong> ${caso.cliente.nombre_comercial}</p>
    <p><strong>Área:</strong> ${caso.area_destino}</p>
    <p><strong>Motivo:</strong> ${caso.motivo}</p>
    <p><strong>Prioridad:</strong> ${caso.prioridad}</p>
    <p><strong>Descripción:</strong> ${caso.problema_descripcion}</p>
    <p><a href="${Deno.env.get('APP_URL')}/casos/${caso.id}">Ver caso en el sistema</a></p>
  `

  await enviarEmail({
    to: caso.area.email_notificacion,
    subject: `[iGAS] Nuevo Caso ${caso.folio} - ${caso.motivo}`,
    html: emailHTML
  })

  // Actualizar flag de email enviado
  await supabaseAdmin
    .from('casos')
    .update({ email_enviado: true })
    .eq('id', caso_id)

  return new Response(JSON.stringify({ success: true }), {
    headers: { 'Content-Type': 'application/json' }
  })
})</div>


<li>⚪ Crear Edge Function para envío de emails</li>
<li>⚪ Configurar servicio de email (Resend/SendGrid)</li>
<li>⚪ Crear templates de email HTML</li>
<li>⚪ Implementar llamada desde trigger o desde Angular</li>

<h4>3.2 Trigger para Enviar Email Automáticamente</h4>
</p><div class="code-block">-- Opción: Usar webhook de Supabase para llamar Edge Function
CREATE OR REPLACE FUNCTION notificar_nuevo_caso()
RETURNS TRIGGER AS $
BEGIN
  -- Insertar en bitácora
  INSERT INTO caso_bitacora (caso_id, usuario_id, tipo, mensaje, datos_adicionales)
  VALUES (
    NEW.id,
    NEW.creado_por,
    'email_enviado',
    'Email de escalamiento enviado',
    jsonb_build_object('area', NEW.area_destino)
  );

  -- Aquí se podría invocar Edge Function o usar webhook
  -- Por ahora registramos el evento

  RETURN NEW;
END;
$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_notificar_nuevo_caso
  AFTER INSERT ON casos
  FOR EACH ROW EXECUTE FUNCTION notificar_nuevo_caso();</div>


<h3>4. Integración Ticket ↔ Caso</h3>

<h4>4.1 Vincular Ticket con Caso</h4>
</p><div class="code-block">-- Agregar campo a tickets
ALTER TABLE tickets ADD COLUMN caso_id UUID REFERENCES casos(id);
ALTER TABLE tickets ADD COLUMN esta_escalado BOOLEAN DEFAULT false;

-- Agregar estatus "Escalado" a tickets
INSERT INTO estatus_tickets (nombre, orden, pausa_sla, es_final, color)
VALUES ('Escalado', 7, true, false, '#9575cd');

-- Función para crear caso desde ticket
CREATE OR REPLACE FUNCTION escalar_ticket_a_caso(
  p_ticket_id UUID,
  p_area_destino TEXT,
  p_motivo TEXT,
  p_descripcion TEXT,
  p_fecha_compromiso DATE
) RETURNS UUID AS $
DECLARE
  v_caso_id UUID;
  v_ticket RECORD;
  v_estatus_escalado UUID;
BEGIN
  -- Obtener ticket
  SELECT * INTO v_ticket FROM tickets WHERE id = p_ticket_id;

  -- Obtener estatus "Escalado"
  SELECT id INTO v_estatus_escalado FROM estatus_tickets WHERE nombre = 'Escalado';

  -- Crear caso
  INSERT INTO casos (
    ticket_id,
    cliente_id,
    problema_descripcion,
    area_destino,
    motivo,
    prioridad,
    estatus_id,
    sla_objetivo_minutos,
    fecha_compromiso,
    creado_por
  )
  SELECT
    v_ticket.id,
    v_ticket.cliente_id,
    p_descripcion,
    p_area_destino,
    p_motivo,
    v_ticket.prioridad,
    (SELECT id FROM estatus_casos WHERE nombre = 'Nuevo'),
    (SELECT sla_default_horas * 60 FROM areas_destino WHERE nombre = p_area_destino),
    p_fecha_compromiso,
    auth.uid()
  RETURNING id INTO v_caso_id;

  -- Actualizar ticket
  UPDATE tickets
  SET
    caso_id = v_caso_id,
    esta_escalado = true,
    estatus_id = v_estatus_escalado
  WHERE id = p_ticket_id;

  -- Registrar en bitácora del ticket
  INSERT INTO ticket_bitacora (ticket_id, usuario_id, tipo, mensaje, datos_adicionales)
  VALUES (
    p_ticket_id,
    auth.uid(),
    'escalamiento',
    'Ticket escalado a ' || p_area_destino,
    jsonb_build_object('caso_id', v_caso_id, 'area', p_area_destino, 'motivo', p_motivo)
  );

  RETURN v_caso_id;
END;
$ LANGUAGE plpgsql SECURITY DEFINER;</div>


<h3>5. Vista de Casos con SLA</h3>
</p><div class="code-block">CREATE OR REPLACE VIEW casos_con_sla AS
SELECT
  c.*,
  EXTRACT(EPOCH FROM (NOW() - c.fecha_creacion))/60 - c.tiempo_pausado_minutos as minutos_transcurridos,
  CASE
    WHEN EXTRACT(EPOCH FROM (NOW() - c.fecha_creacion))/60 - c.tiempo_pausado_minutos < c.sla_objetivo_minutos * 0.7
      THEN 'verde'
    WHEN EXTRACT(EPOCH FROM (NOW() - c.fecha_creacion))/60 - c.tiempo_pausado_minutos <= c.sla_objetivo_minutos
      THEN 'amarillo'
    ELSE 'rojo'
  END as semaforo,
  ROUND(
    ((EXTRACT(EPOCH FROM (NOW() - c.fecha_creacion))/60 - c.tiempo_pausado_minutos) / c.sla_objetivo_minutos * 100)::NUMERIC,
    2
  ) as porcentaje_sla
FROM casos c;</div>


<h3>6. Row Level Security para Casos</h3>
</p><div class="code-block">ALTER TABLE casos ENABLE ROW LEVEL SECURITY;

-- Usuarios del área pueden ver sus casos
CREATE POLICY "Usuarios ven casos de su área"
  ON casos FOR SELECT
  USING (
    area_destino IN (
      SELECT e.nombre
      FROM profiles p
      JOIN equipos e ON p.area_equipo_id = e.id
      WHERE p.id = auth.uid()
    ) OR
    responsable_id = auth.uid()
  );

-- Coordinadores y Admins ven todos
CREATE POLICY "Coordinadores y Admins ven todos los casos"
  ON casos FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM profiles p
      JOIN roles r ON p.rol_id = r.id
      WHERE p.id = auth.uid()
        AND r.nombre IN ('Coordinador', 'Admin')
    )
  );

-- Solo usuarios autenticados pueden crear casos
CREATE POLICY "Usuarios pueden crear casos"
  ON casos FOR INSERT
  WITH CHECK (auth.uid() IS NOT NULL);

-- Responsable o coordinador puede actualizar
CREATE POLICY "Responsable o Coordinador puede actualizar caso"
  ON casos FOR UPDATE
  USING (
    responsable_id = auth.uid() OR
    EXISTS (
      SELECT 1 FROM profiles p
      JOIN roles r ON p.rol_id = r.id
      WHERE p.id = auth.uid()
        AND r.nombre IN ('Coordinador', 'Admin')
    )
  );</div>


<h3>7. Backend - Servicio Angular</h3>

<h4>7.1 CasoService</h4>
</p><div class="code-block">export interface Caso {
  id: string;
  folio: string;
  ticket_id: string;
  cliente_id: string;
  problema_descripcion?: string;
  area_destino: 'Dev' | 'Implementación' | 'Facturación' | 'Proveedor' | 'Cobranza';
  motivo: 'Bug' | 'Mejora' | 'Configuración' | 'Proveedor' | 'Administrativo';
  responsable_id?: string;
  prioridad?: string;
  estatus_id: string;
  sla_objetivo_minutos: number;
  fecha_creacion: string;
  fecha_compromiso?: string;
  resultado?: 'Listo para validar' | 'Regresa a soporte' | 'Cerrado';
  numero_caso_externo?: string;
  email_enviado: boolean;

  // Campos calculados
  semaforo?: 'verde' | 'amarillo' | 'rojo';
  porcentaje_sla?: number;
  minutos_transcurridos?: number;
}</div>


<li>⚪ Crear CasoService</li>
<li>⚪ Implementar escalarTicket(ticketId, datos)</li>
<li>⚪ Implementar getCasos(filtros)</li>
<li>⚪ Implementar getCasoById(id)</li>
<li>⚪ Implementar updateCaso(id, data)</li>
<li>⚪ Implementar cambiarEstatus(id, estatusId, nota)</li>
<li>⚪ Implementar asignarCaso(id, usuarioId)</li>
<li>⚪ Implementar marcarListoParaValidar(id, notas)</li>
<li>⚪ Implementar regresarASoporte(id, motivo)</li>
<li>⚪ Implementar cerrarCaso(id, resultado)</li>
<li>⚪ Implementar registrarNumeroExterno(id, numero)</li>
<li>⚪ Implementar getCasoTimeline(id)</li>
<li>⚪ Implementar agregarNota(casoId, nota)</li>
<li>⚪ Implementar subirAdjunto(casoId, file)</li>
<li>⚪ Implementar enviarEmailEscalamiento(casoId)</li>

<h3>8. Frontend - Módulo de Casos</h3>

<h4>8.1 Vista Principal de Casos</h4>

<li>⚪ Crear módulo features/casos</li>
<li>⚪ Crear componente de listado:</li>
  - ⚪ Tabla con columnas: Folio, Ticket Origen, Cliente, Área, Motivo, Responsable, Estatus, Semáforo, SLA %, Fecha Compromiso
  - ⚪ Badge de área con color por tipo
  - ⚪ Badge de motivo
  - ⚪ Semáforo visual
  - ⚪ Indicador si tiene número externo
  - ⚪ Indicador si email fue enviado
  - ⚪ Filtros:
    - Por área (select)
    - Por semáforo
    - Por estatus
    - Por responsable
    - Por motivo
    - Por fecha compromiso (vencidos/por vencer)
  - ⚪ Búsqueda por folio
  - ⚪ Ordenamiento
  - ⚪ Paginación

<h4>8.2 Modal de Escalamiento (desde Ticket)</h4>

<li>⚪ Crear componente modal de escalamiento:</li>
  - ⚪ Se abre desde detalle de ticket
  - ⚪ Selector de área destino
  - ⚪ Selector de motivo
  - ⚪ Textarea de descripción adicional
  - ⚪ Date picker de fecha compromiso
  - ⚪ Checkbox "Enviar email inmediatamente"
  - ⚪ Preview de datos antes de confirmar
  - ⚪ Loading state
  - ⚪ Confirmación de creación
  - ⚪ Redirigir a detalle del caso creado

<h4>8.3 Detalle de Caso</h4>

<li>⚪ Crear componente de detalle:</li>
  - ⚪ Header con folio del caso
  - ⚪ Link al ticket origen (prominente)
  - ⚪ Badge de área con color corporativo
  - ⚪ Badge de semáforo
  - ⚪ Barra de progreso SLA
  - ⚪ Card de información:
    - Cliente
    - Área destino
    - Motivo
    - Prioridad
    - Responsable
    - Estatus
    - Fecha compromiso (destacado si está próximo/vencido)
    - Número de caso externo (si existe)
    - Email enviado (check/cross)
  - ⚪ Timeline de bitácora
  - ⚪ Sección de adjuntos
  - ⚪ Área de acciones:
    - Cambiar estatus
    - Asignar/reasignar
    - Registrar número de caso externo
    - Marcar como "Listo para validar"
    - Regresar a soporte
    - Cerrar caso
    - Agregar nota
    - Subir adjunto
    - Reenviar email

<h4>8.4 Acciones sobre Casos</h4>

<li>⚪ Implementar cambio de estatus:</li>
  - ⚪ Modal con selector
  - ⚪ Nota obligatoria
  - ⚪ Actualizar fechas
<li>⚪ Implementar asignación/reasignación:</li>
  - ⚪ Filtrar usuarios por área
  - ⚪ Registrar en historial
  - ⚪ Notificar
<li>⚪ Implementar "Listo para validar":</li>
  - ⚪ Modal con notas de resolución
  - ⚪ Cambiar estatus
  - ⚪ Notificar a soporte/ticket original
  - ⚪ Actualizar ticket relacionado
<li>⚪ Implementar "Regresar a soporte":</li>
  - ⚪ Modal con motivo obligatorio
  - ⚪ Cambiar estatus del caso
  - ⚪ Cambiar estatus del ticket a "En atención"
  - ⚪ Notificar al responsable del ticket
  - ⚪ Agregar nota en ticket
<li>⚪ Implementar cierre de caso:</li>
  - ⚪ Validar que tenga resultado
  - ⚪ Modal de confirmación
  - ⚪ Actualizar ticket relacionado si aplica
  - ⚪ Cerrar caso
<li>⚪ Implementar registro de número externo:</li>
  - ⚪ Modal simple con input
  - ⚪ Guardar y registrar en bitácora

<h4>8.5 Integración en Vista de Ticket</h4>

<li>⚪ En detalle de ticket, mostrar:</li>
  - ⚪ Badge "Escalado" si tiene caso
  - ⚪ Link al caso relacionado
  - ⚪ Estatus actual del caso
  - ⚪ Área a la que se escaló
  - ⚪ Botón "Escalar a caso" (si no está escalado)

<h3>9. Panel de Reportes de Casos</h3>

<h4>9.1 Dashboard de Casos</h4>

<li>⚪ Crear dashboard de casos:</li>
  - ⚪ Widget: Total de casos activos
  - ⚪ Widget: Casos por área (gráfica pie)
  - ⚪ Widget: Casos por semáforo
  - ⚪ Widget: Casos próximos a vencer
  - ⚪ Gráfica de cumplimiento SLA por área
  - ⚪ Top 5 casos más antiguos
  - ⚪ Lista de casos vencidos

---

<div class="content-section"><h2>Entregables</h2>

<li>⚪ Módulo de casos completamente funcional</li>
<li>⚪ Integración ticket → caso operativa</li>
<li>⚪ Sistema de email para escalamiento</li>
<li>⚪ Control de tiempo y SLA para casos</li>
<li>⚪ Vista separada de casos con filtros por área</li>
<li>⚪ Flujo completo de escalamiento</li>
<li>⚪ Flujo de regreso a soporte</li>
<li>⚪ Registro de número de caso externo</li>
<li>⚪ RLS policies implementadas</li>

<div class="content-section"><h2>Dependencias</h2>

<li>Fase 1: Usuarios y autenticación</li>
<li>Fase 2: Módulo de tickets (CRÍTICO)</li>
<li>Supabase Edge Functions (para emails)</li>

<div class="content-section"><h2>Criterios de Aceptación</h2>

<li>⚪ Tickets pueden escalarse a casos correctamente</li>
<li>⚪ Email se envía al área correspondiente automáticamente</li>
<li>⚪ Número de caso externo puede registrarse</li>
<li>⚪ SLA de casos se calcula correctamente</li>
<li>⚪ Casos pueden marcarse como "Listo para validar"</li>
<li>⚪ Casos pueden regresar a soporte con notas</li>
<li>⚪ Filtros por área, semáforo y estatus funcionan</li>
<li>⚪ Permisos por área se respetan (RLS)</li>
<li>⚪ Ticket y caso permanecen vinculados</li>

<div class="content-section"><h2>Notas Técnicas Supabase</h2>

<li>Usar **Edge Functions** para envío de emails</li>
<li>**Triggers** para automatizar creación de bitácora</li>
<li>**RLS** para seguridad por área</li>
<li>Considerar **Realtime** para actualizaciones de casos</li>
<li>**Storage** para adjuntos de casos</li>
<li>Función **escalar_ticket_a_caso()** como transacción atómica</li>
</p></div>
    </div>

    <div class="footer">
        <p><strong>iGAS Control Volumétrico</strong></p>
        <p>www.igas.mx | rroque.mor@igas.mx | 443 227 2217</p>
        <p style="margin-top: 15px; font-size: 12px;">
            Última actualización: 11 de enero de 2026
        </p>
    </div>
</body>
</html>